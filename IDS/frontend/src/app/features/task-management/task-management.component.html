<div class="task-management-container">
  <header class="page-header">
    <h1>Gestión de Tareas</h1>
    <button class="btn btn-primary" (click)="toggleForm()" [disabled]="loadingUsers">
      {{ showForm ? 'Cancelar' : '+ Nueva Tarea' }}
    </button>
  </header>

  <!-- Task Form -->
  <div class="task-form" *ngIf="showForm">
    <h3>{{ editingTask ? 'Editar Tarea' : 'Nueva Tarea' }}</h3>
    <form>
      <div class="form-group">
        <label for="title">Título *</label>
        <input
          type="text"
          id="title"
          [(ngModel)]="newTask.title"
          name="title"
          class="form-control"
          placeholder="Título de la tarea"
          required>
      </div>

      <div class="form-group">
        <label for="description">Descripción *</label>
        <textarea
          id="description"
          [(ngModel)]="newTask.description"
          name="description"
          class="form-control"
          rows="3"
          placeholder="Describe la tarea..."
          required></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="assigned_to">Asignar a *</label>
          <select
            id="assigned_to"
            [(ngModel)]="newTask.assigned_to"
            name="assigned_to"
            class="form-control"
            required>
            <option [ngValue]="undefined">Seleccionar usuario...</option>
            <option *ngFor="let user of staffUsers" [ngValue]="user.id">
              {{ user.first_name }} {{ user.last_name }} ({{ user.role }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="priority">Prioridad</label>
          <select
            id="priority"
            [(ngModel)]="newTask.priority"
            name="priority"
            class="form-control">
            <option value="low">Baja</option>
            <option value="medium">Media</option>
            <option value="high">Alta</option>
            <option value="urgent">Urgente</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Estado</label>
          <select
            id="status"
            [(ngModel)]="newTask.status"
            name="status"
            class="form-control">
            <option value="pending">Pendiente</option>
            <option value="in_progress">En Progreso</option>
            <option value="completed">Completada</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="patient">Paciente (opcional)</label>
          <select
            id="patient"
            [(ngModel)]="newTask.patient"
            name="patient"
            class="form-control">
            <option [ngValue]="undefined">Ninguno</option>
            <option *ngFor="let patient of patients" [ngValue]="patient.id">
              {{ patient.first_name }} {{ patient.last_name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="due_date">Fecha de vencimiento (opcional)</label>
          <input
            type="date"
            id="due_date"
            [(ngModel)]="newTask.due_date"
            name="due_date"
            class="form-control">
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="toggleForm()">
          Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="saveTask()">
          {{ editingTask ? 'Actualizar' : 'Crear' }} Tarea
        </button>
      </div>
    </form>
  </div>

  <!-- Task List -->
  <div class="task-list" *ngIf="!loading; else loadingTemplate">
    <div class="task-card" *ngFor="let task of tasks">
      <div class="task-header">
        <h3>{{ task.title }}</h3>
        <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
          {{ formatPriority(task.priority) }}
        </span>
      </div>
      <p class="task-description">{{ task.description }}</p>
      <div class="task-footer">
        <span class="status-badge" [ngClass]="getStatusClass(task.status)">
          {{ formatStatus(task.status) }}
        </span>
        <span class="assigned-to" *ngIf="task.assigned_to_name">
          Asignado a: {{ task.assigned_to_name }}
        </span>
        <span class="due-date" *ngIf="task.due_date">
          Vence: {{ task.due_date }}
        </span>
      </div>
      <div class="task-actions">
        <button class="btn-edit" (click)="editTask(task)">Editar</button>
        <button class="btn-delete" (click)="deleteTask(task.id)">Eliminar</button>
      </div>
    </div>

    <div class="empty-state" *ngIf="tasks.length === 0">
      <p>No hay tareas disponibles</p>
      <button class="btn btn-primary" (click)="toggleForm()" *ngIf="!showForm">
        Crear primera tarea
      </button>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-spinner">Cargando tareas...</div>
  </ng-template>
</div>
